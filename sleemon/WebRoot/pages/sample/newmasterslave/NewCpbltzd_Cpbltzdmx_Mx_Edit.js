/** * @module 质检管理 * @fuc 成品不良通知单 * @version 1.1 * @author zhuxw */$(function(){ 	init();//页面初始化	$("#add").click(function(){	    addRow();	});		$("body").dblclick(function(){	    addRow();	});		$("#delete").click(function(){		//查找当前是否有选中的记录		var checkBox = $("#jsontb tr:gt(0) input:checked");		if(checkBox.length<1){			parent.showErrorMsg("请至少选择一条记录");			return;		}		//获取所有选中的记录		var ids = "";		checkBox.each(function(){			if("" != $(this).val()){				ids = ids+"'"+$(this).val()+"',";			}		});		ids = ids.substr(0,ids.length-1);		//没有ids说明都是页面新增的，数据库中无记录，可以直接remove		if("" == ids){			checkBox.parent().parent().remove();		}else{			parent.showConfirm("您确认要删除吗","bottomcontent.multiRecDeletes();");		}		//删除后scroll可能消失，因此需要重新调整浮动按钮的位置		setFloatPostion();	});		$("#save").click(function(){		//当前所在页面有2种可能，列表展示页面，编辑页面。		var actionType = getActionType();		if("list" == actionType){			//查找当前是否有选中的记录			var checkBox = $("#jsontb tr:gt(0) input:checked");			if(checkBox.length<1){				parent.showErrorMsg("请至少选择一条记录");				return;			}			//对于选中的零星领料单明细校验			if(!formMutiTrChecked()){				return;			}			childSave();		}else{			//编辑页面，子表没有选中记录也可以提交，故不需要校验。			allSave();		}	});		$("#allChecked").click(function(){		var flag = document.getElementById("allChecked").checked;		if(flag){			$("#jsontb :checkbox").attr("checked","true");		}else{			$("#jsontb :checkbox").removeAttr("checked");		}	});});//子表保存function childSave(){	var selRowId = getSelRowId();	var jsonData = multiPackJsonData();	$.ajax({		url: "newmasterslave.shtml?action=childEdit",		type:"POST",		dataType:"text",		data:{"childJsonData":jsonData,"CPBLTZDID":selRowId},		complete: function(xhr){			eval("jsonResult = "+xhr.responseText);			if(jsonResult.success===true){				parent.showMsgPanel("保存成功");				parent.window.gotoBottomPage("label_1");			}else{				parent.showErrorMsg(utf8Decode(jsonResult.messages));			}		}	});}//删除操作function multiRecDeletes(){//查找当前是否有选中的记录	var checkBox = $("#jsontb tr:gt(0) input:checked");	//获取所有选中的记录	var ids = "";	checkBox.each(function(){		ids = ids+"'"+$(this).val()+"',";	});	ids = ids.substr(0,ids.length-1);		$.ajax({		url: "newmasterslave.shtml?action=childDelete",		type:"POST",		dataType:"text",		data:{"CPBLTZDMXIDS":ids},		complete: function(xhr){			eval("jsonResult = "+xhr.responseText);			if(jsonResult.success===true){				parent.showMsgPanel("删除成功");				checkBox.parent().parent().remove();				//设置删除操作。有删除时返回后需要刷新页面。否则直接跳转上一页。				$("#delFlag").val("true");			}else{				parent.showErrorMsg(utf8Decode(jsonResult.messages));			}		}	});}	function allSave(){	//主表form校验	var parentCheckedRst = parent.topcontent.formChecked('mainForm');	if(!parentCheckedRst){		return;	}	//明细校验	if(!formMutiTrChecked()){		return;	}	var selRowId = getSelRowId();	//获取json数据	var parentData = parent.topcontent.siglePackJsonData();	var childData;	if($("#jsontb tr:gt(0) input:checked").length>0){		childData = multiPackJsonData();	}		$.ajax({		url: "newmasterslave.shtml?action=edit",		type:"POST",		dataType:"text",		data:{"parentJsonData":parentData,"childJsonData":childData,"CPBLTZDID":selRowId },		complete: function (xhr){			eval("jsonResult = "+xhr.responseText);			if(jsonResult.success===true){				saveSuccess("保存成功","newmasterslave.shtml?action=toFrame");			}else{				parent.showErrorMsg(utf8Decode(jsonResult.messages));			}		}	});}function gobacknew(){   newGoBack("newmasterslave.shtml?action=toFrame");}			//table增加一行function addRow(arrs){	if(null == arrs){		arrs = ['','','','','','','','','','','','','','','','',''];	}	//样式行	var rownum = $("#jsontb tr").length;	var classrow = rownum% 2;	rownum=_row_num;_row_num++;	$("#jsontb tr:last-child").after("<tr class='list_row"+classrow+"' onmouseover='mover(this)' onmouseout='mout(this)'></tr>");	$("#jsontb tr:last-child")		    .append("<td nowrap align='center'>"		    			+"<input type='checkbox' style='height:12px;valign:middle' json='CPBLTZDMXID' name='CPBLTZDMXID"+rownum+"' value='"+arrs[0]+"'/></td>")		   .append('<td nowrap align="left" style="display:none;"><input type="text" name="CPZJTZDMXID'+rownum+'" seltarget="selMXXX" autocheck="true" inputtype="string" label="" maxlength="32" value="'+arrs[2]+'"size="1" />&nbsp;</td>')		   .append('<td nowrap align="left" style="display:none;"><input type="text" json="CPZJXMID" id="CPZJXMID'+rownum+'" name="CPZJXMID'+rownum+'"autocheck="true" inputtype="string" label="成品质检项目ID" maxlength="32" value="'+arrs[2]+'"size="10" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="CPZJXMBH" id="CPZJXMBH'+rownum+'" name="CPZJXMBH'+rownum+'"  autocheck="true" mustinput="true" inputtype="string" label="成品质检项目编号" maxlength="30" value="'+arrs[3]+'"size="9"/>'		    +'&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="CPZJXMMC" id="CPZJXMMC'+rownum+'" name="CPZJXMMC'+rownum+'"  autocheck="true" inputtype="string" label="成品质检项目名称" maxlength="100" value="'+arrs[4]+'"size="10" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="ZJXMLB" id="ZJXMLB'+rownum+'" name="ZJXMLB'+rownum+'" mustinput="true"  autocheck="true" inputtype="string" label="质检项目类别" maxlength="30" value="'+arrs[5]+'"size="8" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="YYBZ" id="YYBZ'+rownum+'" name="YYBZ'+rownum+'"  autocheck="true" mustinput="true" inputtype="string" label="应用标准" maxlength="30" value="'+arrs[6]+'"size="6" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="JYCS" id="JYCS'+rownum+'" name="JYCS'+rownum+'" autocheck="true" mustinput="true" inputtype="string" label="检验参数" maxlength="50" value="'+arrs[7]+'"size="6" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="HGBZ" id="HGBZ'+rownum+'" name="HGBZ'+rownum+'"  autocheck="true" inputtype="string" label="合格标准" maxlength="50" value="'+arrs[8]+'"size="6" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="JYZ" id="JYZ'+rownum+'" name="JYZ'+rownum+'"  autocheck="true" inputtype="string" label="检验值" maxlength="50" value="'+arrs[9]+'"size="6" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="RBJSSL" name="RBJSSL'+rownum+'" autocheck="true" inputtype="float" label="让步接收数量" maxlength="8" value="'+arrs[10]+'"size="3" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="BFSL" name="BFSL'+rownum+'" autocheck="true" inputtype="float" label="报废数量" maxlength="8" value="'+arrs[11]+'"size="3" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="THSL" name="THSL'+rownum+'" autocheck="true" inputtype="float" label="退回数量" maxlength="8" value="'+arrs[12]+'"size="3" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="XSSL" name="XSSL'+rownum+'" autocheck="true" inputtype="float" label="修色数量" maxlength="8" value="'+arrs[13]+'"size="3" />&nbsp;</td>')		    .append('<td nowrap align="left"><input type="text" json="REMARK" name="REMARK'+rownum+'" autocheck="true" inputtype="string" label="备注" maxlength="250" value="'+arrs[14]+'"size="10" />&nbsp;</td>')	$("#jsontb tr:last-child").find("td:gt(0)").click(function(){		$(this).parent().find("input[type='checkbox']").attr("checked","checked");	});	//form校验设置	trCheckInit($("#jsontb tr:gt("+(rownum-1)+") input"));	trCheckInit($("#jsontb tr:gt("+(rownum-1)+") select"));	//InitFormValidator(0);}function init(){	$("#jsontb tr").each(function(){		$(this).find("td:gt(0)").click(function(){			$(this).parent().find("input[type='checkbox']").attr("checked","checked");		});	});	var actionType = parent.document.getElementById("actionType").value;    $("#jsontb tr:gt(0) :checkbox").attr("checked","true");	//form校验设置	InitFormValidator(0);}function getActionType(){	return parent.document.getElementById("actionType").value;}function getSelRowId(){	return parent.document.getElementById("selRowId").value;}