<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<!--
@author lyg
@function 
@version 2013-08-11 17:38:52
-->
<sqlMap  namespace="Progressadvc">
<!-- 定义AdvcorderModel,AdvcorderModelChld,AdvcorderModelGchld ,AdvcorderModelTrace-->
<typeAlias type="com.hoperun.drp.sale.advcorder.model.AdvcorderModel" alias="AdvcorderModel"/>
<typeAlias type="com.hoperun.drp.sale.advcorder.model.AdvcorderModelChld" alias="AdvcorderModelChld" />
<typeAlias type="com.hoperun.drp.sale.advcorder.model.AdvcorderModelGchld" alias="AdvcorderModelGchld" />
<typeAlias type="com.hoperun.drp.sale.advcorder.model.AdvcorderModelTrace" alias="AdvcorderModelTrace" />
<!-- 使用AdvcorderModel装载结果集 -->
<resultMap id="AdvcorderModel" class="AdvcorderModel">
    <result column="ADVC_ORDER_ID" property="ADVC_ORDER_ID" />
</resultMap>
<!-- 使用AdvcorderModelChld装载结果集 -->
<resultMap id="AdvcorderModelChld" class="AdvcorderModelChld">
    <result column="ADVC_ORDER_DTL_ID" property="ADVC_ORDER_DTL_ID" />
</resultMap>
<!-- 使用AdvcorderModelGchld装载结果集 -->
<resultMap id="AdvcorderModelGchld" class="AdvcorderModelGchld">
    <result column="PAYMENT_DTL_ID" property="PAYMENT_DTL_ID" />
</resultMap>
<!-- 使用AdvcorderModelTrace装载结果集 -->
<resultMap id="AdvcorderModelTrace" class="AdvcorderModelTrace">
    <result column="ADVC_ORDER_TRACE_ID" property="ADVC_ORDER_TRACE_ID" />
</resultMap>
<!--主表动态查询 and 列表分页 -->

<sql id="orderSql">
   <isNotEmpty prepend=" " property="orderField">$orderField$</isNotEmpty>
</sql>

<!--主表动态查询 and 列表分页 -->
<sql id="queryDynSql">
  <isNotEmpty prepend="and" property="ADVC_ORDER_NO">
    u.ADVC_ORDER_NO like '%'||#ADVC_ORDER_NO#||'%'
  </isNotEmpty>
  <isNotEmpty prepend="and" property="TERM_NO">
    u.TERM_NO like '%'||#TERM_NO#||'%'
  </isNotEmpty>
  <isNotEmpty prepend="and" property="TERM_NAME">
    u.TERM_NAME like '%'||#TERM_NAME#||'%'
  </isNotEmpty>
  <isNotEmpty prepend="and" property="LEDGER_ID">
  	u.LEDGER_ID=#LEDGER_ID#
  </isNotEmpty>
  <isNotEmpty prepend="and" property="BILL_TYPE">
  	u.BILL_TYPE=#BILL_TYPE#
  </isNotEmpty>
  <isNotEmpty prepend="and" property="CONTRACT_NO">
  	u.CONTRACT_NO like '%'||#CONTRACT_NO#||'%'
  </isNotEmpty>
  <isNotEmpty prepend="and" property="FROM_BILL_NO">
  	u.FROM_BILL_NO like '%'||#FROM_BILL_NO#||'%'
  </isNotEmpty>
  
  <isNotEmpty prepend=" " property="PROMOTE_NOQuery">
  	$PROMOTE_NOQuery$
  </isNotEmpty>
  <isNotEmpty prepend=" " property="PROMOTE_NAMEQuery">
  	$PROMOTE_NAMEQuery$
  </isNotEmpty>
  
  <isNotEmpty prepend="and" property="SALE_DATE_BEG">
     <![CDATA[u.SALE_DATE>=to_date(#SALE_DATE_BEG#,'yyyy-MM-DD')]]>
  </isNotEmpty>
  <isNotEmpty prepend="and" property="SALE_DATE_END">
     <![CDATA[u.SALE_DATE<=to_date(#SALE_DATE_END#,'yyyy-MM-DD')]]>
  </isNotEmpty>
  <isNotEmpty prepend="and" property="SALE_PSON_NAME">
    u.SALE_PSON_NAME like '%'||#SALE_PSON_NAME#||'%'
  </isNotEmpty>
  <isNotEmpty prepend="and" property="CUST_NAME">
    u.CUST_NAME like '%'||#CUST_NAME#||'%'
  </isNotEmpty>
   <isNotEmpty prepend="and" property="BEGIN_CRE_TIME">
     <![CDATA[u.CRE_TIME>=to_date(#BEGIN_CRE_TIME#,'yyyy-MM-DD HH24:MI:SS')]]>
  </isNotEmpty>
  <isNotEmpty prepend="and" property="END_CRE_TIME">
     <![CDATA[u.CRE_TIME<=to_date(#END_CRE_TIME#,'yyyy-MM-DD HH24:MI:SS')]]>
  </isNotEmpty>
  <isNotEmpty prepend="and" property="STATE">
    u.STATE =#STATE#
  </isNotEmpty>
  <isNotEmpty prepend="and" property="CLOSEFLAG">
    a.STATE =#CLOSEFLAG#
  </isNotEmpty>
  <isNotEmpty prepend="and" property="searchSTATE">
    u.STATE in ($searchSTATE$)
  </isNotEmpty>
	<isNotEmpty prepend="and " property="DEL_FLAG">
	        u.DEL_FLAG=#DEL_FLAG#
	</isNotEmpty>
	 <isNotEmpty prepend="and" property="TEL">
    u.TEL like '%'||#TEL#||'%'
  </isNotEmpty>
    <isNotEmpty prepend="and " property="QXJBCON">
	        $QXJBCON$
	</isNotEmpty>
</sql>
<!-- 主表查询SQL -->
<sql id="coreSql">
  <![CDATA[ 
	select 
		u.ADVC_ORDER_ID,
		u.GOODS_ORDER_ID,
		u.ADVC_ORDER_NO,
		u.FROM_BILL_NO,
		u.TERM_ID,
		u.TERM_NO,
		u.TERM_NAME,
		to_char(u.SALE_DATE,'yyyy-MM-DD') SALE_DATE,
		u.SALE_PSON_ID,
		u.SALE_PSON_NAME,
		u.CUST_NAME,
		u.TEL,
		u.RECV_ADDR,
		u.ADVC_AMOUNT,
		u.PAYABLE_AMOUNT,
		u.REMARK,
		to_char(u.PFMC_DATE,'yyyy-MM-DD') PFMC_DATE,
		u.DEAL_FLAG,
		u.STTLE_FLAG,
		u.CRE_NAME,
		u.CREATOR,
		to_char(u.CRE_TIME,'yyyy-MM-DD HH24:MI:SS') CRE_TIME,
		u.UPD_NAME,
		u.UPDATOR,
		to_char(u.UPD_TIME,'yyyy-MM-DD HH24:MI:SS') UPD_TIME,
		u.DEPT_ID,
		u.DEPT_NAME,
		u.ORG_ID,
		u.ORG_NAME,
		u.LEDGER_ID,
		u.LEDGER_NAME,
		u.STATE,
		u.DEL_FLAG,
		u.CONTRACT_NO,
		u.TOTAL_AMOUNT,
		u.DISCOUNT_AMOUNT,
		u.PROMOTE_ID,
		u.PROMOTE_NO,
		u.PROMOTE_NAME,
		NVL(u.PRINT_NUM,0)PRINT_NUM
      from DRP_ADVC_ORDER u
   ]]>
    <dynamic prepend="where">
	   <include refid="queryDynSql" />
	</dynamic>
	<dynamic prepend="order by ">
	   <include refid="orderSql"/>
	</dynamic>
</sql>
<!-- 主表分页查询 -->
<select id="pageQuery" parameterClass="map" resultClass="java.util.HashMap">
		<include refid="public.pageBegin" />
		<include refid="coreSql" />
		<include refid="public.pageEnd" />
	</select>
<!-- 分页计数 -->
<select id="pageCount" parameterClass="map" resultClass="int">
      <![CDATA[
      	select count(0) cnt
		  FROM DRP_ADVC_ORDER u
      ]]>
	<dynamic prepend="where">
			<include refid="queryDynSql"/>
	</dynamic>
</select>
<!-- 主表查询 -->
<select id="query" parameterClass="map" resultClass="java.util.HashMap">
	<include refid="coreSql" />
</select>
<insert id="insert" parameterClass="map">
  <![CDATA[
	  insert into DRP_ADVC_ORDER(
		 ADVC_ORDER_ID,
         SALE_PSON_ID,
         ADVC_ORDER_NO,
         TERM_NO,
         TERM_ID,
         TERM_NAME,
         SALE_DATE,
         SALE_PSON_NAME,
         CUST_NAME,
         TEL,
         ADVC_AMOUNT,
         PAYABLE_AMOUNT,
         RECV_ADDR,
         REMARK,
         CRE_NAME,
         CREATOR,
         CRE_TIME,
         DEPT_ID,
         DEPT_NAME,
         ORG_ID,
         ORG_NAME,
         LEDGER_ID,
         LEDGER_NAME,
         STATE,
         STTLE_FLAG,
         PFMC_DATE,
         DEL_FLAG,
         BILL_TYPE,
         DEAL_FLAG,
         PAYED_TOTAL_AMOUNT,
         CONTRACT_NO,
         TOTAL_AMOUNT,
		 DISCOUNT_AMOUNT,
		 PROMOTE_ID,
		 PROMOTE_NO,
		 PROMOTE_NAME,
		 CUSTOMER_AGE,
		 CUSTOMER_SOURCE,
		 CUSTOMER_DEMAND
	   )values(
		#ADVC_ORDER_ID#,
        #SALE_PSON_ID#,
        #ADVC_ORDER_NO#,
        #TERM_NO#,
        #TERM_ID#,
        #TERM_NAME#,
		to_date(#SALE_DATE#,'YYYY-MM-DD'),
        #SALE_PSON_NAME#,
        #CUST_NAME#,
        #TEL#,
        #ADVC_AMOUNT#,
        #PAYABLE_AMOUNT#,
        #RECV_ADDR#,
        #REMARK#,
        #CRE_NAME#,
        #CREATOR#,
		sysdate, 
        #DEPT_ID#,
        #DEPT_NAME#,
        #ORG_ID#,
        #ORG_NAME#,
        #LEDGER_ID#,
        #LEDGER_NAME#,
        #STATE#,
        #STTLE_FLAG#,
        to_date(#PFMC_DATE#,'YYYY-MM-DD'),
		#DEL_FLAG#,
		#BILL_TYPE#,
		#DEAL_FLAG#,
		#PAYED_TOTAL_AMOUNT#,
		#CONTRACT_NO#,
		#TOTAL_AMOUNT#,
		#DISCOUNT_AMOUNT#,
		#PROMOTE_ID#,
		#PROMOTE_NO#,
		#PROMOTE_NAME#,
		#CUSTOMER_AGE#,
		#CUSTOMER_SOURCE#,
		#CUSTOMER_DEMAND#
		)
   ]]>
</insert>
<update id="updateById" parameterClass="map">
	<![CDATA[ update DRP_ADVC_ORDER ]]>
	<dynamic prepend="set">
    <isNotNull property="SALE_PSON_ID" prepend=","><![CDATA[SALE_PSON_ID = #SALE_PSON_ID# ]]></isNotNull>
    <isNotNull property="ADVC_ORDER_NO" prepend=","><![CDATA[ADVC_ORDER_NO = #ADVC_ORDER_NO# ]]></isNotNull>
    <isNotNull property="TERM_NO" prepend=","><![CDATA[TERM_NO = #TERM_NO# ]]></isNotNull>
    <isNotNull property="TERM_ID" prepend=","><![CDATA[TERM_ID = #TERM_ID# ]]></isNotNull>
    <isNotNull property="TERM_NAME" prepend=","><![CDATA[TERM_NAME = #TERM_NAME# ]]></isNotNull>
    <isNotNull property="SALE_PSON_NAME" prepend=","><![CDATA[SALE_PSON_NAME = #SALE_PSON_NAME# ]]></isNotNull>
    <isNotNull property="CUST_NAME" prepend=","><![CDATA[CUST_NAME = #CUST_NAME# ]]></isNotNull>
    <isNotNull property="TEL" prepend=","><![CDATA[TEL = #TEL# ]]></isNotNull>
    <isNotNull property="ADVC_AMOUNT" prepend=","><![CDATA[ADVC_AMOUNT = #ADVC_AMOUNT# ]]></isNotNull>
    <isNotNull property="PAYABLE_AMOUNT" prepend=","><![CDATA[PAYABLE_AMOUNT = #PAYABLE_AMOUNT# ]]></isNotNull>
    <isNotNull property="RECV_ADDR" prepend=","><![CDATA[RECV_ADDR = #RECV_ADDR# ]]></isNotNull>
    <isNotNull property="REMARK" prepend=","><![CDATA[REMARK = #REMARK# ]]></isNotNull>
    <isNotNull property="UPD_NAME" prepend=","><![CDATA[UPD_NAME = #UPD_NAME# ]]></isNotNull>
    <isNotNull property="UPDATOR" prepend=","><![CDATA[UPDATOR = #UPDATOR# ]]></isNotNull>
     <isNotNull property="UPD_TIME" prepend=","><![CDATA[UPD_TIME = sysdate ]]></isNotNull>
    <isNotNull property="STATE" prepend=","><![CDATA[STATE = #STATE# ]]></isNotNull>
    <isNotNull property="SALE_DATE" prepend=","><![CDATA[SALE_DATE = to_date(#SALE_DATE#,'yyyy-mm-dd') ]]></isNotNull>
    <isNotNull property="PFMC_DATE" prepend=","><![CDATA[PFMC_DATE = to_date(#PFMC_DATE#,'yyyy-mm-dd') ]]></isNotNull>
    <isNotNull property="PFMC_DATE1" prepend=","><![CDATA[PFMC_DATE = '']]></isNotNull>
    <isNotNull property="ADVC_AMOUNT_FLAG" prepend=","><![CDATA[ADVC_AMOUNT_FLAG = #ADVC_AMOUNT_FLAG#]]></isNotNull>
    <isNotNull property="CHK_PRICE_PSON_ID" prepend=","><![CDATA[CHK_PRICE_PSON_ID = #CHK_PRICE_PSON_ID#]]></isNotNull>
    <isNotNull property="CHK_PRICE_PSON_NAME" prepend=","><![CDATA[CHK_PRICE_PSON_NAME = #CHK_PRICE_PSON_NAME#]]></isNotNull>
    <isNotNull property="CONTRACT_NO" prepend=","><![CDATA[CONTRACT_NO = #CONTRACT_NO#]]></isNotNull>
    <isNotNull property="TOTAL_AMOUNT" prepend=","><![CDATA[TOTAL_AMOUNT = #TOTAL_AMOUNT#]]></isNotNull>
    <isNotNull property="DISCOUNT_AMOUNT" prepend=","><![CDATA[DISCOUNT_AMOUNT = #DISCOUNT_AMOUNT#]]></isNotNull>
    <isNotNull property="PAYED_TOTAL_AMOUNT" prepend=","><![CDATA[PAYED_TOTAL_AMOUNT = #PAYED_TOTAL_AMOUNT#]]></isNotNull>
    <isNotNull property="PROMOTE_ID" prepend=","><![CDATA[PROMOTE_ID = #PROMOTE_ID#]]></isNotNull>
    <isNotNull property="PROMOTE_NO" prepend=","><![CDATA[PROMOTE_NO = #PROMOTE_NO#]]></isNotNull>
    <isNotNull property="PROMOTE_NAME" prepend=","><![CDATA[PROMOTE_NAME = #PROMOTE_NAME#]]></isNotNull>
    <isNotNull property="CUSTOMER_AGE" prepend=","><![CDATA[CUSTOMER_AGE = #CUSTOMER_AGE#]]></isNotNull>
    <isNotNull property="CUSTOMER_SOURCE" prepend=","><![CDATA[CUSTOMER_SOURCE = #CUSTOMER_SOURCE#]]></isNotNull>
    <isNotNull property="CUSTOMER_DEMAND" prepend=","><![CDATA[CUSTOMER_DEMAND = #CUSTOMER_DEMAND#]]></isNotNull>
    
    </dynamic>
	<![CDATA[  where ADVC_ORDER_ID = #ADVC_ORDER_ID#]]>
</update>

<update id="updateForPayment" parameterClass="map">
	update DRP_ADVC_ORDER set PAYED_TOTAL_AMOUNT = nvl(PAYED_TOTAL_AMOUNT,0) + #STATEMENTS_AMOUNT# 
		where ADVC_ORDER_ID = #ADVC_ORDER_ID#
</update>

<update id="updateForRefund" parameterClass="map">
	update DRP_ADVC_ORDER set PAYED_TOTAL_AMOUNT = nvl(PAYED_TOTAL_AMOUNT,0) - #STATEMENTS_AMOUNT# 
		where ADVC_ORDER_ID = #ADVC_ORDER_ID#
</update>

<!-- 逻辑删除 只是更新状态-->
<delete id="delete" parameterClass="map">
	<![CDATA[ update DRP_ADVC_ORDER 
	               set DEL_FLAG = #DEL_FLAG#
                      ,UPD_NAME=#UPD_NAME#
                     ,UPDATOR=#UPDATOR#
                      ,UPD_TIME=sysdate
 	  where 
	     ADVC_ORDER_ID = #ADVC_ORDER_ID:VARCHAR# 
    ]]>
</delete>
<select id="loadById" parameterClass="String" resultClass="java.util.HashMap">
	<![CDATA[ 
	  select 
		u.ADVC_ORDER_ID,
		u.GOODS_ORDER_ID,
		u.ADVC_ORDER_NO,
		u.FROM_BILL_NO,
		u.TERM_ID,
		u.TERM_NO,
		u.TERM_NAME,
		to_char(u.SALE_DATE,'yyyy-MM-DD') SALE_DATE,
		u.SALE_PSON_ID,
		u.SALE_PSON_NAME,
		u.CUST_NAME,
		u.TEL,
		u.RECV_ADDR,
		u.ADVC_AMOUNT,
		u.PAYABLE_AMOUNT,
		u.REMARK,
		to_char(u.PFMC_DATE,'yyyy-MM-DD') PFMC_DATE,
		u.DEAL_FLAG,
		u.STTLE_FLAG,
		u.CRE_NAME,
		u.CREATOR,
		to_char(u.CRE_TIME,'yyyy-MM-DD HH24:MI:SS') CRE_TIME,
		u.UPD_NAME,
		u.UPDATOR,
		to_char(u.UPD_TIME,'yyyy-MM-DD HH24:MI:SS') UPD_TIME,
		u.DEPT_ID,
		u.DEPT_NAME,
		u.ORG_ID,
		u.ORG_NAME,
		u.LEDGER_ID,
		u.LEDGER_NAME,
		u.STATE,
		u.DEL_FLAG,
		NVL(u.PAYED_TOTAL_AMOUNT,0) PAYED_TOTAL_AMOUNT,
		NVL(u.DEDUCTED_TOTAL_AMOUNT,0) DEDUCTED_TOTAL_AMOUNT,
		u.CONTRACT_NO,
		NVL(u.TOTAL_AMOUNT,0) TOTAL_AMOUNT,
		NVL(u.DISCOUNT_AMOUNT,0) DISCOUNT_AMOUNT,
		u.RETURN_RSON,
		(NVL(u.PAYABLE_AMOUNT,0)-NVL(u.PAYED_TOTAL_AMOUNT,0))RESIDUE_AMOUNT,
        u.PROMOTE_ID,
		u.PROMOTE_NO,
		u.PROMOTE_NAME,
		to_char(u.RETURN_STATEMENT_DATE,'yyyy-mm-dd')RETURN_STATEMENT_DATE,
		u.CUSTOMER_AGE,
		u.CUSTOMER_SOURCE,
		u.CUSTOMER_DEMAND,
		u.CHK_PRICE_PSON_NAME
	  from
       DRP_ADVC_ORDER u 
	  where 
		u.ADVC_ORDER_ID = #ADVC_ORDER_ID#
	]]>
</select>
<!-- 明细操作开始-->
<!--明细查询条件定义 -->
<sql id="queryDynSqlChld">
  <isNotEmpty prepend="and" property="DEL_FLAG">
     u.DEL_FLAG=#DEL_FLAG#
  </isNotEmpty>
</sql>
<!--明细查询条件定义 -->
<sql id="queryDynSqlGchld">
  <isNotEmpty prepend="and" property="DEL_FLAG">
     u.DEL_FLAG=#DEL_FLAG#
  </isNotEmpty>
</sql>  
<!-- 查询SQL -->
<sql id="orderSqlChld">
	 <isNotEmpty prepend=" " property="orderField">$orderField$</isNotEmpty>
</sql>
<!-- 查询SQL -->
<sql id="orderSqlGchld">
	 <isNotEmpty prepend=" " property="orderField">$orderField$</isNotEmpty>
</sql>
<sql id="coreSqlChld">
	<![CDATA[ 
     select 
		u.ADVC_ORDER_DTL_ID,
		u.ADVC_ORDER_ID,
		u.PRD_ID,
		u.PRD_NO,
		u.PRD_NAME,
		u.PRD_SPEC,
		u.PRD_COLOR,
		u.BRAND,
		u.STD_UNIT,
		u.PRICE,
		u.DECT_RATE,
		u.DECT_PRICE,
		u.ORDER_NUM,
		u.PAYABLE_AMOUNT,
		u.REMARK,
		u.DEL_FLAG,
		u.PRD_TYPE,
		u.SPCL_TECH_ID,
        a.SPCL_TECH_FLAG,
        u.IS_FREEZE_FLAG,
        u.FREEZE_STORE_NAME,
        u.FREEZE_NUM,
		u.FREEZE_STORE_ID,
		u.FREEZE_STORE_NO,
		u.CANCLE_ORDER_NUM,
		u.SEND_NUM,
		u.STATE,
		(
			select count(a.ADVC_SEND_REQ_ID) 
			from DRP_ADVC_SEND_REQ a 
			left join DRP_ADVC_SEND_REQ_DTL b on a.ADVC_SEND_REQ_ID=b.ADVC_SEND_REQ_ID  
			where b.from_bill_dtl_id=u.ADVC_ORDER_DTL_ID and a.STATE='审核通过' and a.DEL_FLAG=0 and b.DEL_FLAG=0
		) COUNT,
		to_char(u.ORDER_RECV_DATE,'yyyy-mm-dd') ORDER_RECV_DATE,
		a.SPCL_SPEC_REMARK,
		a.DM_SPCL_TECH_NO
       from DRP_ADVC_ORDER_DTL u 
       left join DRP_SPCL_TECH a on a.SPCL_TECH_ID = u.SPCL_TECH_ID and a.USE_FLAG = #USE_FLAG#
   ]]>
</sql>
<sql id="coreSqlGchld">
	<![CDATA[ 
     select 
		u.PAYMENT_DTL_ID,
		u.ADVC_ORDER_ID,
		u.PAY_TYPE,
		u.PAY_INFO,
		u.PAY_AMONT,
		u.DEL_FLAG,
		u.PAY_BILL_NO
       from DRP_PAYMENT_DTL u 
   ]]>
</sql>
<sql id="coreSqlTrace">
	<![CDATA[ 
     select 
		u.ADVC_ORDER_TRACE_ID,
		u.ADVC_ORDER_ID,
		u.ACTION,
		u.ACTOR,
		to_char(u.ACT_TIME,'yyyy-MM-DD HH24:MI:SS') ACT_TIME,
		u.BILL_NO,
		u.REMARK
       from DRP_ADVC_ORDER_TRACE u
   ]]>
</sql>
 <!-- 根据主表ID查询明细 -->
  <select id="queryChldByFkId" parameterClass="map" resultClass="java.util.HashMap">
	  <include refid="coreSqlChld"/>
	  <dynamic prepend="where">
		<isNotEmpty prepend="and" property="ADVC_ORDER_ID">
		  	u.ADVC_ORDER_ID=#ADVC_ORDER_ID#
		 </isNotEmpty>
	  </dynamic>
	  <dynamic prepend="and">
	   <include refid="queryDynSqlGchld" />
	  </dynamic>
	  <isNotNull prepend=" order by " property="orderField">
			<include refid="orderSqlChld"/>
	  </isNotNull>
  </select>
   <!-- 根据主表ID查询明细 -->
  <select id="queryGchldByFkId" parameterClass="map" resultClass="java.util.HashMap">
	  <include refid="coreSqlGchld"/>
	  <dynamic prepend="where">
			u.ADVC_ORDER_ID=#ADVC_ORDER_ID#
	  </dynamic>
	  <dynamic prepend="and">
	   <include refid="queryDynSqlGchld" />
	  </dynamic>
	  <isNotNull prepend=" order by " property="orderField">
			<include refid="orderSqlGchld"/>
	  </isNotNull>
  </select>
     <!-- 根据主表ID查询跟踪 -->
  <select id="queryTraceByFkId" parameterClass="string" resultClass="java.util.HashMap">
	  <include refid="coreSqlTrace"/>
	  <dynamic prepend="where">
			u.ADVC_ORDER_ID=#ADVC_ORDER_ID#
	  </dynamic>
	  order by ACT_TIME asc
  </select>
 <!--根据明细表IDS查询明细 -->
 <select id="loadChldByIds" parameterClass="map" resultClass="java.util.HashMap">
	  <include refid="coreSqlChld"/>
	  <dynamic prepend="where">
	        u.ADVC_ORDER_DTL_ID in ($ADVC_ORDER_DTL_IDS$)
	  </dynamic>
	  <dynamic prepend="and">
	   <include refid="queryDynSqlChld" />
	  </dynamic>
	  <isNotNull prepend=" order by " property="orderField">
			<include refid="orderSqlChld"/>
	  </isNotNull>
  </select>
<!--明细表插入 -->
<insert id="insertChld" parameterClass="map">
  <![CDATA[
	  insert into DRP_ADVC_ORDER_DTL(
		 ADVC_ORDER_DTL_ID,
		 ADVC_ORDER_ID,
         PRD_NO,
         PRD_ID,
         PRD_NAME,
         PRD_SPEC,
         PRD_COLOR,
         BRAND,
         STD_UNIT,
         PRICE,
         DECT_RATE,
         DECT_PRICE,
         ORDER_NUM,
         PAYABLE_AMOUNT,
         REMARK,
         DEL_FLAG,
         SESSION_ID,
         PRD_TYPE,
         SPCL_TECH_ID,
         SPCL_TECH_FLAG,
         IS_FREEZE_FLAG,
		 FREEZE_STORE_ID,
		 FREEZE_STORE_NO,
		 FREEZE_STORE_NAME,
		 FREEZE_NUM,
		 ORDER_RECV_DATE,
		 STATE
	   )values(
		#ADVC_ORDER_DTL_ID#,
		#ADVC_ORDER_ID#,
        #PRD_NO#,
        #PRD_ID#,
        #PRD_NAME#,
        #PRD_SPEC#,
        #PRD_COLOR#,
        #BRAND#,
        #STD_UNIT#,
        #PRICE#,
        #DECT_RATE#,
        #DECT_PRICE#,
        #ORDER_NUM#,
        #PAYABLE_AMOUNT#,
        #REMARK#,
		#DEL_FLAG#,
		#SESSION_ID#,
		#PRD_TYPE#,
		#SPCL_TECH_ID#,
		#SPCL_TECH_FLAG#,
		#IS_FREEZE_FLAG#,
		#FREEZE_STORE_ID#,
		#FREEZE_STORE_NO#,
		#FREEZE_STORE_NAME#,
		#FREEZE_NUM#,
		to_date(#ORDER_RECV_DATE#,'yyyy-mm-dd'),
		#STATE#
		)
   ]]>
</insert>
<!--明细表更新 -->
<update id="updateChldById" parameterClass="map">
	<![CDATA[ update DRP_ADVC_ORDER_DTL ]]>
	<dynamic prepend="set">
	<isNotNull property="SPCL_TECH_ID" prepend=","><![CDATA[SPCL_TECH_ID = #SPCL_TECH_ID# ]]></isNotNull>
    <isNotNull property="PRD_NO" prepend=","><![CDATA[PRD_NO = #PRD_NO# ]]></isNotNull>
    <isNotNull property="PRD_ID" prepend=","><![CDATA[PRD_ID = #PRD_ID# ]]></isNotNull>
    <isNotNull property="PRD_NAME" prepend=","><![CDATA[PRD_NAME = #PRD_NAME# ]]></isNotNull>
    <isNotNull property="PRD_SPEC" prepend=","><![CDATA[PRD_SPEC = #PRD_SPEC# ]]></isNotNull>
    <isNotNull property="PRD_COLOR" prepend=","><![CDATA[PRD_COLOR = #PRD_COLOR# ]]></isNotNull>
    <isNotNull property="BRAND" prepend=","><![CDATA[BRAND = #BRAND# ]]></isNotNull>
    <isNotNull property="STD_UNIT" prepend=","><![CDATA[STD_UNIT = #STD_UNIT# ]]></isNotNull>
    <isNotNull property="PRICE" prepend=","><![CDATA[PRICE = #PRICE# ]]></isNotNull>
    <isNotNull property="DECT_RATE" prepend=","><![CDATA[DECT_RATE = #DECT_RATE# ]]></isNotNull>
    <isNotNull property="DECT_PRICE" prepend=","><![CDATA[DECT_PRICE = #DECT_PRICE# ]]></isNotNull>
    <isNotNull property="ORDER_NUM" prepend=","><![CDATA[ORDER_NUM = #ORDER_NUM# ]]></isNotNull>
    <isNotNull property="PAYABLE_AMOUNT" prepend=","><![CDATA[PAYABLE_AMOUNT = #PAYABLE_AMOUNT# ]]></isNotNull>
    <isNotNull property="REMARK" prepend=","><![CDATA[REMARK = #REMARK# ]]></isNotNull>
    <isNotNull property="PRD_TYPE" prepend=","><![CDATA[PRD_TYPE = #PRD_TYPE# ]]></isNotNull>
    <isNotNull property="IS_FREEZE_FLAG" prepend=","><![CDATA[IS_FREEZE_FLAG = #IS_FREEZE_FLAG# ]]></isNotNull>
    <isNotNull property="ORDER_RECV_DATE" prepend=","><![CDATA[ORDER_RECV_DATE = to_date(#ORDER_RECV_DATE#,'yyyy-mm-dd') ]]></isNotNull>
    </dynamic>
	<![CDATA[ where ADVC_ORDER_DTL_ID = #ADVC_ORDER_DTL_ID#]]>
</update>
<!--根据明细IDs删除明细 -->
<delete id="deleteChldByIds" parameterClass="map">
	<![CDATA[ update DRP_ADVC_ORDER_DTL 
	               set DEL_FLAG = #DEL_FLAG#	 
 	  where 
	      ADVC_ORDER_DTL_ID in ($ADVC_ORDER_DTL_IDS$)
    ]]>
</delete>
<!--根据主键ID删除明细 -->
<delete id="delChldByFkId" parameterClass="map">
	<![CDATA[ update DRP_ADVC_ORDER_DTL 
	               set DEL_FLAG = #DEL_FLAG#	 
 	  where 
	      ADVC_ORDER_ID = #ADVC_ORDER_ID:VARCHAR#
    ]]>
</delete>



 <!--根据明细表IDS查询明细 -->
 <select id="loadGchldByIds" parameterClass="map" resultClass="java.util.HashMap">
	  <include refid="coreSqlGchld"/>
	  <dynamic prepend="where">
	        u.PAYMENT_DTL_ID in ($PAYMENT_DTL_IDS$)
	  </dynamic>
	  <dynamic prepend="and">
	   <include refid="queryDynSqlGchld" />
	  </dynamic>
	  <isNotNull prepend=" order by " property="orderField">
			<include refid="orderSqlGchld"/>
	  </isNotNull>
  </select>
<!--明细表插入 -->
<insert id="insertGchld" parameterClass="map">
  <![CDATA[
	  insert into DRP_PAYMENT_DTL(
		 PAYMENT_DTL_ID,
		 ADVC_ORDER_ID,
         PAY_TYPE,
         PAY_INFO,
         PAY_AMONT,
         DEL_FLAG,
         PAY_BILL_NO
	   )values(
		#PAYMENT_DTL_ID#,
		#ADVC_ORDER_ID#,
        #PAY_TYPE#,
        #PAY_INFO#,
        #PAY_AMONT#,
		#DEL_FLAG#,
		#PAY_BILL_NO#
		)
   ]]>
</insert>
<!--明细表更新 -->
<update id="updateGchldById" parameterClass="map">
	<![CDATA[ update DRP_PAYMENT_DTL ]]>
	<dynamic prepend="set">
    <isNotNull property="PAY_TYPE" prepend=","><![CDATA[PAY_TYPE = #PAY_TYPE# ]]></isNotNull>
    <isNotNull property="PAY_INFO" prepend=","><![CDATA[PAY_INFO = #PAY_INFO# ]]></isNotNull>
    <isNotNull property="PAY_AMONT" prepend=","><![CDATA[PAY_AMONT = #PAY_AMONT# ]]></isNotNull>
    <isNotNull property="PAY_BILL_NO" prepend=","><![CDATA[PAY_BILL_NO = #PAY_BILL_NO# ]]></isNotNull>
    </dynamic>
	<![CDATA[ where PAYMENT_DTL_ID = #PAYMENT_DTL_ID#]]>
</update>
<!--根据明细IDs删除明细 -->
<delete id="deleteGchldByIds" parameterClass="map">
	<![CDATA[ update DRP_PAYMENT_DTL 
	               set DEL_FLAG = #DEL_FLAG#	 
 	  where 
	      PAYMENT_DTL_ID in ($PAYMENT_DTL_IDS$)
    ]]>
</delete>
<!--根据主键ID删除明细 -->
<delete id="delGchldByFkId" parameterClass="map">
	<![CDATA[ update DRP_PAYMENT_DTL 
	               set DEL_FLAG = #DEL_FLAG#	 
 	  where 
	      ADVC_ORDER_ID = #ADVC_ORDER_ID:VARCHAR#
    ]]>
</delete>
<!-- 按id计算付款总金额 -->
<select id="loadGchldSum" parameterClass="String" resultClass="double">
	<![CDATA[
		select sum(PAY_AMONT) from drp_payment_dtl
			where ADVC_ORDER_ID=#ADVC_ORDER_ID# and DEL_FLAG=0
	]]>
</select>


<update id="updateAdvcAmountById" parameterClass="String">	
	<![CDATA[ update DRP_ADVC_ORDER  
	  set  ADVC_AMOUNT = 
	  (select sum(PAY_AMONT) from DRP_PAYMENT_DTL where ADVC_ORDER_ID=#ADVC_ORDER_ID# and DEL_FLAG=0)
	 where ADVC_ORDER_ID=#ADVC_ORDER_ID# ]]>	
</update>

<update id="commitById" parameterClass="map">	
	<![CDATA[ update ${SYSSCHEMA}.DRP_ADVC_ORDER ]]>
	<dynamic prepend="set">
		<isNotNull property="STATE" prepend=","><![CDATA[STATE = #STATE#]]></isNotNull>
		<isNotNull property="UPDATOR" prepend=","><![CDATA[UPDATOR = #UPDATOR#]]></isNotNull>
		<isNotNull property="UPD_NAME" prepend=","><![CDATA[UPD_NAME = #UPD_NAME#]]></isNotNull>
		<isNotNull property="UPD_TIME" prepend=","><![CDATA[UPD_TIME =sysdate]]></isNotNull>
		<isNotNull property="RETURN_RSON" prepend=","><![CDATA[RETURN_RSON =#RETURN_RSON#]]></isNotNull>
	</dynamic>
	<![CDATA[ where ADVC_ORDER_ID=#ADVC_ORDER_ID# ]]>	
</update>
<!--按id查找定金金额 -->
<select id="amountGetById" parameterClass="String" resultClass="double">
	<![CDATA[
		select ADVC_AMOUNT from DRP_ADVC_ORDER where ADVC_ORDER_ID=#ADVC_ORDER_ID# and DEL_FLAG=0
	]]>
</select>
<!-- 查询子表应收金额之和 -->
<select id="getPAYABLE_AMOUNT" parameterClass="map" resultClass="double">
	<![CDATA[
		select sum(PAYABLE_AMOUNT) from DRP_ADVC_ORDER_DTL where ADVC_ORDER_ID=#ADVC_ORDER_ID# and DEL_FLAG=#DEL_FLAG# and PRD_TYPE!='赠品'
	]]>
</select>
<!-- 查询子表优惠之和 -->
<select id="getDISCOUNT_AMOUNT" parameterClass="map" resultClass="double">
	<![CDATA[
		select sum(PAYABLE_AMOUNT) from DRP_ADVC_ORDER_DTL where ADVC_ORDER_ID=#ADVC_ORDER_ID# and DEL_FLAG=#DEL_FLAG# and PRD_TYPE='赠品'
	]]>
</select>
<!-- 查询主表应收总额 -->
<select id="getPAYABLE_AMOUNTAdv" parameterClass="String" resultClass="double">
	<![CDATA[
		select PAYABLE_AMOUNT from DRP_ADVC_ORDER where ADVC_ORDER_ID=#ADVC_ORDER_ID#
	]]>
</select>
<!-- 按终端编号查询终端信息 -->
<select id="getTermByNo" parameterClass="map" resultClass="java.util.HashMap">
	<![CDATA[
		select TERM_ID,TERM_NO,TERM_NAME from BASE_TERMINAL where TERM_NO=#TERM_NO# and STATE=#STATE# and DEL_FLAG=#DEL_FLAG# and CHANN_ID_P=#CHANN_ID_P#
	]]>
</select>
<!-- 按业务员编号查询终端信息 -->
<select id="getEmployeeByNo" parameterClass="string" resultClass="java.util.HashMap">
	<![CDATA[
		select RYXXID,XM from T_SYS_RYXX where RYBH=#RYBH#
	]]>
</select>
<!-- 按货品编号查询货品信息 -->
<select id="getProductByNo" parameterClass="map" resultClass="java.util.HashMap">
	<![CDATA[
		select PRD_ID,PRD_NO,PRD_NAME,PRD_SPEC,PRD_COLOR,BRAND,STD_UNIT,FACT_PRICE from BASE_PRODUCT where PRD_NO=#PRD_NO# and STATE=#STATE# and DEL_FLAG=#DEL_FLAG# and FINAL_NODE_FLAG=#FINAL_NODE_FLAG#
	]]>
</select>
<!-- 强删主表 -->
<delete id="deleteAdv" parameterClass="string">
	<![CDATA[
		delete from DRP_ADVC_ORDER where ADVC_ORDER_ID=#ADVC_ORDER_ID#
	]]>
</delete>
<!-- 强删预订单明细-->
<delete id="delChld" parameterClass="string">
		delete from DRP_ADVC_ORDER_DTL where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</delete>
<!-- 强删付款明细 -->
<delete id="delGchld" parameterClass="string">
		delete from DRP_PAYMENT_DTL where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</delete>
<!-- 强删工艺单 -->
<delete id="delSpcl" parameterClass="string">
		delete from DRP_ADVC_SPCL_TECH where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</delete>
<!-- 修改业绩日期 -->
<update id="upPFMC_DATE" parameterClass="string">
	<![CDATA[
		update DRP_ADVC_ORDER set PFMC_DATE=(select SALE_DATE from DRP_ADVC_ORDER where ADVC_ORDER_ID=#ADVC_ORDER_ID#) where ADVC_ORDER_ID=#ADVC_ORDER_ID#
	]]>
</update>
<!-- 根据当前登录人id获取最低折扣率 -->
<select id="getTERM_DECT_FROM" parameterClass="string" resultClass="string">
	select TERM_DECT_FROM from T_SYS_RYXX where RYXXID=#RYXXID#
</select>
<select id="getAdvcById" parameterClass="string" resultClass="java.util.HashMap">
	select 
			ADVC_ORDER_ID,
			ADVC_ORDER_NO,
			TERM_ID,
			TERM_NO,
			TERM_NAME,
			SALE_DATE,
			SALE_PSON_ID,
			SALE_PSON_NAME,
			CUST_NAME,
			TEL,
			RECV_ADDR,
			ORDER_RECV_DATE,
			ADVC_AMOUNT,
			PAYABLE_AMOUNT,
			STATE,
			REMARK
	from DRP_ADVC_ORDER
	where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</select>
<insert id="insertSTATEMENTS" parameterClass="map">
	insert into DRP_STATEMENTS(
		STATEMENTS_ID,
		STATEMENTS_NO,
		ADVC_ORDER_ID,
		ADVC_ORDER_NO,
		BILL_TYPE,
		TERM_ID,
		TERM_NO,
		TERM_NAME,
		SALE_DATE,
		SALE_PSON_ID,
		SALE_PSON_NAME,
		CUST_NAME,
		TEL,
		ORDER_RECV_DATE,
		ADVC_AMOUNT,
		STATEMENTS_AMOUNT,
		PAYABLE_AMOUNT,
		STATE,
		REMARK,
		CREATOR,
		CRE_NAME,
		CRE_TIME,
		DEPT_ID,
		DEPT_NAME,
		ORG_ID,
		ORG_NAME,
		LEDGER_ID,
		LEDGER_NAME,
		DEL_FLAG,
		STATEMENT_DATE
	)
	select 
		#STATEMENTS_ID#,
		#STATEMENTS_NO#,
		ADVC_ORDER_ID,
		ADVC_ORDER_NO,
		#BILL_TYPE#,
		TERM_ID,
		TERM_NO,
		TERM_NAME,
		SALE_DATE,
		SALE_PSON_ID,
		SALE_PSON_NAME,
		CUST_NAME,
		TEL,
		ORDER_RECV_DATE,
		ADVC_AMOUNT,
		ADVC_AMOUNT,
		PAYABLE_AMOUNT,
		#STATE#,
		REMARK,
		#CREATOR#,
		#CRE_NAME#,
		sysdate,
		#DEPT_ID#,
		#DEPT_NAME#,
		#ORG_ID#,
		#ORG_NAME#,
		#LEDGER_ID#,
		#LEDGER_NAME#,
		#DEL_FLAG#,
		SALE_DATE
	from DRP_ADVC_ORDER where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</insert>
<insert id="insertSTATEMENTS_DTL" parameterClass="map">
	insert into DRP_STATEMENTS_DTL(
		STATEMENTS_DTL_ID,
		STATEMENTS_ID,
		PRD_ID,
		PRD_NO,
		PRD_NAME,
		PRD_SPEC,
		PRD_COLOR,
		BRAND,
		STD_UNIT,
		PRICE,
		DECT_RATE,
		DECT_PRICE,
		REMARK,
		DEL_FLAG,
		STATEMENTS_NUM,
		STATEMENTS_AMOUNT
	)values(
		#STATEMENTS_DTL_ID#,
		#STATEMENTS_ID#,
		#PRD_ID#,
		#PRD_NO#,
		#PRD_NAME#,
		#PRD_SPEC#,
		#PRD_COLOR#,
		#BRAND#,
		#STD_UNIT#,
		#PRICE#,
		#DECT_RATE#,
		#DECT_PRICE#,
		#REMARK#,
		#DEL_FLAG#,
		#ORDER_NUM#,
		#PAYABLE_AMOUNT#
	)
</insert>
<insert id="insertSTATEMENTS_PAYMENT_DTL" parameterClass="map">
	insert into DRP_STATEMENTS_PAYMENT_DTL(
		STATEMENTS_PAYMENT_DTL_ID,
		STATEMENTS_ID,
		PAY_TYPE,
		PAY_BILL_NO,
		PAY_AMONT,
		PAY_INFO,
		DEL_FLAG
	)values(
		#STATEMENTS_PAYMENT_DTL_ID#,
		#STATEMENTS_ID#,
		#PAY_TYPE#,
		#PAY_BILL_NO#,
		#PAY_AMONT#,
		#PAY_INFO#,
		#DEL_FLAG#
	)
</insert>
<select id="getAdv" parameterClass="string" resultClass="java.util.HashMap">
	select a.TERM_NO,to_char(a.SALE_DATE,'YYYY-MM-DD') SALE_DATE,b.RYBH,a.CUST_NAME,a.TEL,a.RECV_ADDR,to_char(a.ORDER_RECV_DATE,'YYYY-MM-DD') ORDER_RECV_DATE,a.ADVC_AMOUNT,a.REMARK
	from DRP_ADVC_ORDER a
	left join T_SYS_RYXX b
	on a.SALE_PSON_ID=b.RYXXID
	where a.ADVC_ORDER_ID=#ADVC_ORDER_ID#
</select>
<select id="getDtl" parameterClass="map" resultClass="java.util.HashMap">
	select 
		a.PRD_NO,a.ORDER_NUM,a.PAYABLE_AMOUNT,a.REMARK,b.REMARK as SPCLREMARK
	from DRP_ADVC_ORDER_DTL a
	left join DRP_ADVC_SPCL_TECH b 
	on a.ADVC_ORDER_DTL_ID=b.ADVC_ORDER_DTL_ID
	where a.ADVC_ORDER_ID=#ADVC_ORDER_ID#
	and a.DEL_FLAG=#DEL_FLAG#
	
</select>
<select id="getDate" resultClass="string">
	select to_char(sysdate,'yyyy-mm-dd') from dual
</select>
<update id="upUSE_FLAG" parameterClass="map">
	<![CDATA[ update DRP_SPCL_TECH ]]>
	<dynamic prepend="set">
		<isNotNull property="USE_FLAG" prepend=","><![CDATA[USE_FLAG = #USE_FLAG#]]></isNotNull>
	</dynamic>
	<![CDATA[ where SPCL_TECH_ID in ($SPCL_TECH_IDS$) ]]>	
</update>
<update id="upFreeze" parameterClass="map">
	<![CDATA[ update DRP_ADVC_ORDER_DTL ]]>
	<dynamic prepend="set">
		<isNotNull property="IS_FREEZE_FLAG" prepend=",">
			<![CDATA[
				IS_FREEZE_FLAG = #IS_FREEZE_FLAG#,
				FREEZE_STORE_ID=#FREEZE_STORE_ID#,
				FREEZE_STORE_NO=#FREEZE_STORE_NO#,
				FREEZE_STORE_NAME=#FREEZE_STORE_NAME#  
			]]>
		</isNotNull>
		<isNotNull property="FREEZE_NUM" prepend=","><![CDATA[FREEZE_NUM = #FREEZE_NUM#]]></isNotNull>
	</dynamic>
	<![CDATA[ where ADVC_ORDER_DTL_ID in ($ADVC_ORDER_DTL_IDS$) ]]>
	
</update>
<insert id="insertTrace" parameterClass="map">
	insert into DRP_ADVC_ORDER_TRACE(
		ADVC_ORDER_TRACE_ID,
		ADVC_ORDER_ID,
		ACTION,
		ACTOR,
		ACT_TIME,
		BILL_NO,
		REMARK
	)values(
		#ADVC_ORDER_TRACE_ID#,
		#ADVC_ORDER_ID#,
		#ACTION#,
		#ACTOR#,
		sysdate,
		#BILL_NO#,
		#REMARK#
	)
</insert>
<select id="getTerminalInfoById" parameterClass="string" resultClass="java.util.HashMap">
	select 
		a.TERM_ID,
		a.TERM_NO,
		a.TERM_NAME 
	from BASE_TERMINAL a
	left join T_SYS_BMXX b on b.BMXXID=a.TERM_ID
	where BMXXID=#BMXXID#
</select>
<update id="addORDER_RECV_DATE" parameterClass="map">
	update DRP_ADVC_ORDER
   set ORDER_RECV_DATE = (select MIN(u.ORDER_RECV_DATE)
                            from DRP_ADVC_ORDER_DTL u
                           where u.ADVC_ORDER_ID = #ADVC_ORDER_ID#
                             and u.DEL_FLAG = #DEL_FLAG# and u.ORDER_RECV_DATE is not null)
 where ADVC_ORDER_ID = #ADVC_ORDER_ID# 
</update>
<select id="getRate" resultClass="string" parameterClass="map">
	select min(DECT_RATE) from DRP_ADVC_ORDER_DTL where ADVC_ORDER_ID=#ADVC_ORDER_ID# and DEL_FLAG=#DEL_FLAG# and PRD_TYPE not in ($PRD_TYPE$)
</select>


<select id="queryAdvcMaxBillNo" parameterClass="map" resultClass="java.util.HashMap">
    select row_.*
	  from ( 
	      select t.ADVC_ORDER_NO from DRP_ADVC_ORDER t  where  substr(t.ADVC_ORDER_NO,#index#, 8)=#date#
	      and LEDGER_ID=#LEDGER_ID#
	      order by t.ADVC_ORDER_NO desc) row_
	 where rownum = 1
 
</select>

<select id="qryMaxFrezzDays" parameterClass="String" resultClass="int">
      select NVL(MAX_FREEZE_DAYS,0) MAX_FREEZE_DAYS   from BASE_CHANN where CHANN_ID=#ledger_Id#
</select>
<update id="upStartDoUncomm" parameterClass="map">
	<![CDATA[
		update DRP_ADVC_ORDER set STATE=#STATE#,UPDATOR=#UPDATOR#,UPD_NAME=#UPD_NAME#,UPD_TIME=sysdate
		where ADVC_ORDER_ID=#ADVC_ORDER_ID#
	]]>
</update>

<!-- 查询客户收款单 -->
<select id="loadStatementsByAdvcId" parameterClass="map" resultClass="java.util.HashMap">
	<![CDATA[ 
	  select 
		u.STATEMENTS_ID,
		u.STATEMENTS_NO,
		u.ADVC_ORDER_ID,
		u.ADVC_ORDER_NO,
		u.TERM_ID,
		u.TERM_NO,
		u.TERM_NAME,
		to_char(u.SALE_DATE,'yyyy-MM-DD') SALE_DATE,
		u.SALE_PSON_ID,
		u.SALE_PSON_NAME,
		u.CUST_NAME,
		u.TEL,
		to_char(u.ORDER_RECV_DATE,'yyyy-MM-DD') ORDER_RECV_DATE,
		u.PAYABLE_AMOUNT,
		u.ADVC_AMOUNT,
		u.PAYED_TOTAL_AMOUNT,
		u.DEDUCTED_TOTAL_AMOUNT,
		u.STATEMENTS_AMOUNT,
		u.DEDUCT_AMOUNT,
		u.STATENEBTS_ATT,
		u.REMARK,
		u.CRE_NAME,
		u.CREATOR,
		to_char(u.CRE_TIME,'yyyy-MM-DD HH24:MI:SS') CRE_TIME,
		u.UPD_NAME,
		u.UPDATOR,
		to_char(u.UPD_TIME,'yyyy-MM-DD HH24:MI:SS') UPD_TIME,
		u.DEPT_ID,
		u.DEPT_NAME,
		u.ORG_ID,
		u.ORG_NAME,
		u.LEDGER_ID,
		u.LEDGER_NAME,
		u.STATE,
		u.DEL_FLAG,
		u.BILL_TYPE
	  from
       DRP_STATEMENTS u 
	  where 
		u.ADVC_ORDER_ID = #ADVC_ORDER_ID#
		and u.DEL_FLAG = #DEL_FLAG#
	]]>
</select>
<select id="qeuryAdvcStoreAcct" parameterClass="map" resultClass="java.util.HashMap">
	select a.ADVC_ORDER_NO,a.TERM_NAME,to_char(a.SALE_DATE,'yyyy-mm-dd')SALE_DATE,a.TEL,sum(b.ORDER_NUM) ORDER_NUM,a.ORDER_RECV_DATE
		from DRP_ADVC_ORDER a,V_DD c,DRP_ADVC_ORDER_DTL b
		where a.LEDGER_ID=#LEDGER_ID#  and a.ADVC_ORDER_ID=b.ADVC_ORDER_ID 
		and b.PRD_ID=#PRD_ID# 
		and NVL(b.SPCL_TECH_ID,'null')=NVL(#SPCL_TECH_ID#,'null') 
		and a.DEL_FLAG=#DEL_FLAG# 
		and b.DEL_FLAG=#DEL_FLAG#
		and c.SJZDBH='DRP_ADVC_ORDER_STATE'  
		and c.SJXZ>='4'
		and a.STATE=c.SJXMC
		and NVL(b.ORDER_NUM,0)>NVL(b.SEND_NUM,0) 
	group by 
		a.ADVC_ORDER_NO,
		a.TERM_NAME,
		a.SALE_DATE,
		a.TEL,
		a.ORDER_RECV_DATE
	order by 
		ORDER_RECV_DATE,a.ADVC_ORDER_NO
		
</select>
<select id="getPAYED_TOTAL_AMOUNT" parameterClass="string" resultClass="int">
	select a.PAYED_TOTAL_AMOUNT from DRP_ADVC_ORDER a where a.ADVC_ORDER_ID = (select ADVC_ORDER_ID from DRP_STATEMENTS where STATEMENTS_ID=#STATEMENTS_ID#) 
</select>
<select id="checkNum" parameterClass="map" resultClass="int">
	<![CDATA[
		select count(1) cnt 
		from DRP_ADVC_ORDER_DTL
		where  NVL(ORDER_NUM,0)<=NVL(SEND_NUM,0) and ADVC_ORDER_DTL_ID in ($ADVC_ORDER_DTL_IDS$) and DEL_FLAG=#DEL_FLAG#
	]]>
</select>
<update id="upChldNumById" parameterClass="map">
	update DRP_ADVC_ORDER_DTL set 
		ORDER_NUM=NVL(SEND_NUM,0),
		PAYABLE_AMOUNT=NVL(SEND_NUM,0)*DECT_PRICE,
		CANCLE_ORDER_NUM=NVL(ORDER_NUM,0)-NVL(SEND_NUM,0),
		STATE=#STATE#
	where ADVC_ORDER_DTL_ID in ($ADVC_ORDER_DTL_IDS$) and DEL_FLAG=0
</update>
<update id="updateAdvcById" parameterClass="map">
	update DRP_ADVC_ORDER set
		PAYABLE_AMOUNT=#PAYABLE_AMOUNT#,
		DISCOUNT_AMOUNT=#DISCOUNT_AMOUNT#,
		TOTAL_AMOUNT=NVL(#PAYABLE_AMOUNT#,0)+NVL(#DISCOUNT_AMOUNT#,0)
	where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</update>
<update id="updateStateMent" parameterClass="map">
	update DRP_STATEMENTS set PAYABLE_AMOUNT=#PAYABLE_AMOUNT# where ADVC_ORDER_ID=#ADVC_ORDER_ID# and DEL_FLAG=#DEL_FLAG#
</update>
<update id="updateMoney" parameterClass="map">
	update DRP_ADVC_ORDER set
		PAYABLE_AMOUNT=NVL(#PAYABLE_AMOUNT#,0),
		DISCOUNT_AMOUNT=NVL(#DISCOUNT_AMOUNT#,0),
		TOTAL_AMOUNT=NVL(#TOTAL_AMOUNT#,0)
	where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</update>
<select id="checkReturnAudit" parameterClass="map" resultClass="java.util.HashMap">
		select 
			(select COUNT(1) from DRP_ADVC_ORDER where DEAL_FLAG=#DEAL_FLAG# and DEL_FLAG=#DEL_FLAG# and ADVC_ORDER_ID=#ADVC_ORDER_ID#)ORDERFLAG,
			(select COUNT(1) from DRP_ADVC_SEND_REQ where FROM_BILL_ID=#ADVC_ORDER_ID# and DEL_FLAG=#DEL_FLAG#)SENDFLAG,
			(select count(1) from DRP_STATEMENTS where ADVC_ORDER_ID=#ADVC_ORDER_ID# and BILL_TYPE ='正常收款' and DEL_FLAG=#DEL_FLAG#)STATEMENTSFLAG,
			(select count(1) from DRP_STATEMENTS where ADVC_ORDER_ID=#ADVC_ORDER_ID# and BILL_TYPE ='销售退款' and DEL_FLAG=#DEL_FLAG#)RETUADVCFLAG
		from dual
</select>
<update id="delStatements" parameterClass="map">
	update DRP_STATEMENTS set DEL_FLAG=#DEL_FLAG# where ADVC_ORDER_ID=#ADVC_ORDER_ID# and BILL_TYPE=#BILL_TYPE#
</update>

<select id="checkWriteFlag" resultClass="int" parameterClass="string">
		select sum(c.WRITE_OFF_AMONT) 
		from DRP_STATEMENTS a 
		left join DRP_STATEMENTS_PAYMENT_DTL b on a.STATEMENTS_ID=b.STATEMENTS_ID 
		left join DRP_WRITE_OFF_DTL c on b.STATEMENTS_PAYMENT_DTL_ID=c.STATEMENTS_PAYMENT_DTL_ID
		where c.DEL_FLAG=0 and b.DEL_FLAG=0 and a.DEL_FLAG=0 and a.ADVC_ORDER_ID=#ADVC_ORDER_ID#
</select>
<update id="txUpSpclEditFlag" parameterClass="map">
	update DRP_SPCL_TECH set TECH_NO_EDIT_FLAG=#TECH_NO_EDIT_FLAG# 
	where SPCL_TECH_ID in (select SPCL_TECH_ID from DRP_ADVC_ORDER_DTL where DEL_FLAG=#DEL_FLAG# and ADVC_ORDER_ID=#ADVC_ORDER_ID# and SPCL_TECH_ID is not null)
	and USE_FLAG=#USE_FLAG#
</update>


<update id="delStatementsDtls" parameterClass="map">
	update DRP_STATEMENTS_PAYMENT_DTL set DEL_FLAG=#DEL_FLAG# 
	where  STATEMENTS_ID in (
	 select STATEMENTS_ID from DRP_STATEMENTS 
	 where ADVC_ORDER_ID=#ADVC_ORDER_ID# and BILL_TYPE=#BILL_TYPE#
	)
</update>

<select id="queryWriteoffCount" parameterClass="map" resultClass="int">
select count(0)
  from DRP_WRITE_OFF_DTL
 where DEL_FLAG = 0
   and STATEMENTS_PAYMENT_DTL_ID in
       (select STATEMENTS_PAYMENT_DTL_ID
          from DRP_STATEMENTS_PAYMENT_DTL
         where DEL_FLAG = 0
           and STATEMENTS_ID = (select STATEMENTS_ID from DRP_STATEMENTS 
				                     where DEL_FLAG = 0 and ADVC_ORDER_ID=#ADVC_ORDER_ID# 
				                     and BILL_TYPE=#BILL_TYPE#
				                )
       )
	 
</select>


<select id="expertExcel" parameterClass="map" resultClass="java.util.HashMap">
	<![CDATA[
		 select 
		u.ADVC_ORDER_ID,
		u.GOODS_ORDER_ID,
		u.ADVC_ORDER_NO,
		u.TERM_ID,
		u.TERM_NO,
		u.TERM_NAME,
		to_char(u.SALE_DATE,'yyyy-MM-DD') SALE_DATE,
		u.SALE_PSON_ID,
		u.SALE_PSON_NAME,
		u.CUST_NAME,
		u.TEL,
		u.RECV_ADDR,
		u.ADVC_AMOUNT,
		u.PAYABLE_AMOUNT F_PAYABLE_AMOUNT,
		u.REMARK,
		to_char(u.PFMC_DATE,'yyyy-MM-DD') PFMC_DATE,
		u.DEAL_FLAG,
		u.STTLE_FLAG,
		u.CRE_NAME,
		u.CREATOR,
		to_char(u.CRE_TIME,'yyyy-MM-DD HH24:MI:SS') CRE_TIME,
		u.UPD_NAME,
		u.UPDATOR,
		to_char(u.UPD_TIME,'yyyy-MM-DD HH24:MI:SS') UPD_TIME,
		u.DEPT_ID,
		u.DEPT_NAME,
		u.ORG_ID,
		u.ORG_NAME,
		u.LEDGER_ID,
		u.LEDGER_NAME,
		u.STATE,
		u.DEL_FLAG,
		u.CONTRACT_NO,
		u.TOTAL_AMOUNT,
		u.DISCOUNT_AMOUNT,
		u.PROMOTE_ID,
		u.PROMOTE_NO,
		u.PROMOTE_NAME,
		a.PRD_ID,
		a.PRD_NO,
		a.PRD_NAME,
		a.PRD_SPEC,
		a.PRD_COLOR,
		a.BRAND,
		a.STD_UNIT,
		a.PRICE,
		a.DECT_RATE,
		a.DECT_PRICE,
		a.ORDER_NUM,
		a.PAYABLE_AMOUNT,
		a.REMARK,
		a.DEL_FLAG,
		a.PRD_TYPE,
		b.SPCL_TECH_ID,
        b.SPCL_TECH_FLAG,
        to_char(a.ORDER_RECV_DATE,'yyyy-mm-dd') ORDER_RECV_DATE,
        (case when NVL(a.IS_FREEZE_FLAG,0)=1 then '是' else '否' end )IS_FREEZE_FLAG,
        NVL(a.FREEZE_NUM,0)FREEZE_NUM,
		a.FREEZE_STORE_ID,
		a.FREEZE_STORE_NO,
		a.FREEZE_STORE_NAME,
		NVL(a.CANCLE_ORDER_NUM,0)CANCLE_ORDER_NUM,
		NVL(a.SEND_NUM,0)SEND_NUM,
		a.STATE ROW_STATE,
		b.DM_SPCL_TECH_NO,
        b.SPCL_DTL_REMARK
      from DRP_ADVC_ORDER u  
      left join DRP_ADVC_ORDER_DTL a on u.ADVC_ORDER_ID = a.ADVC_ORDER_ID
      left join DRP_SPCL_TECH b on b.SPCL_TECH_ID = a.SPCL_TECH_ID and b.USE_FLAG = 1
		
	]]>
	<dynamic prepend="where">
	u.DEL_FLAG=0 and a.DEL_FLAG=0  and 
	   <include refid="queryDynSql" />
	</dynamic>
</select>

<select id="priceChldQuery" resultClass="java.util.HashMap" parameterClass="string">
	select a.ADVC_ORDER_DTL_ID,
       a.PRD_NO,
       a.PRD_NAME,
       a.PRD_SPEC,
       a.PRD_COLOR,
       a.BRAND,
       a.STD_UNIT,
       a.PRICE,
       a.DECT_RATE,
       a.DECT_PRICE,
       a.ORDER_NUM,
       a.SPCL_TECH_ID,
       f.DM_SPCL_TECH_NO,
       f.SPCL_TECH_FLAG,
       to_char(a.ORDER_RECV_DATE,'yyyy-mm-dd')ORDER_RECV_DATE,
       a.PAYABLE_AMOUNT,
       a.REMARK
  from DRP_ADVC_ORDER_DTL a
  left join DRP_ADVC_SEND_REQ_DTL b
    on a.ADVC_ORDER_DTL_ID = b.FROM_BILL_DTL_ID and b.DEL_FLAG = 0
  left join DRP_ADVC_SEND_REQ c
    on c.ADVC_SEND_REQ_ID = b.ADVC_SEND_REQ_ID and c.DEL_FLAG = 0
  left join DRP_STOREOUT d
    on d.FROM_BILL_ID = c.ADVC_SEND_REQ_ID and d.DEL_FLAG = 0
  left join DRP_STOREOUT_DTL e
    on d.STOREOUT_ID = e.STOREOUT_ID and e.DEL_FLAG = 0
   and e.FROM_BILL_DTL_ID = b.ADVC_SEND_REQ_DTL_ID
  left join DRP_SPCL_TECH f on f.SPCL_TECH_ID=a.SPCL_TECH_ID and f.USE_FLAG=1 
 where a.DEL_FLAG = 0
   and a.ADVC_ORDER_ID = #ADVC_ORDER_ID#
   and a.STATE='正常'
 group by a.ADVC_ORDER_DTL_ID,
          a.PRD_NO,
          a.PRD_NAME,
          a.PRD_SPEC,
          a.PRD_COLOR,
          a.BRAND,
          a.STD_UNIT,
          a.PRICE,
          a.DECT_RATE,
          a.DECT_PRICE,
          a.ORDER_NUM,
          a.SPCL_TECH_ID,
          f.DM_SPCL_TECH_NO,
       	  f.SPCL_TECH_FLAG,
       	  to_char(a.ORDER_RECV_DATE,'yyyy-mm-dd'),
       	  a.PAYABLE_AMOUNT,
       	  a.REMARK
having sum(NVL(e.REAL_NUM, 0)) = 0
	
</select>
<select id="checkRealNum" parameterClass="string" resultClass="int">
	select sum(NVL(e.REAL_NUM, 0)) count
	  from DRP_ADVC_ORDER_DTL a
	  left join DRP_ADVC_SEND_REQ_DTL b
	    on a.ADVC_ORDER_DTL_ID = b.FROM_BILL_DTL_ID
	   and b.DEL_FLAG = 0
	  left join DRP_ADVC_SEND_REQ c
	    on c.ADVC_SEND_REQ_ID = b.ADVC_SEND_REQ_ID
	   and c.DEL_FLAG = 0
	  left join DRP_STOREOUT d
	    on d.FROM_BILL_ID = c.ADVC_SEND_REQ_ID
	   and d.DEL_FLAG = 0
	  left join DRP_STOREOUT_DTL e
	    on d.STOREOUT_ID = e.STOREOUT_ID
	   and e.DEL_FLAG = 0
	   and e.FROM_BILL_DTL_ID = b.ADVC_SEND_REQ_DTL_ID
	 where a.DEL_FLAG = 0
	   and a.ADVC_ORDER_DTL_ID in ($ADVC_ORDER_DTL_IDS$)
</select>
<select id="geiAdvcId" parameterClass="string" resultClass="string">
	select ADVC_ORDER_ID
	  from DRP_ADVC_ORDER_DTL
	 where ADVC_ORDER_DTL_ID in ($ADVC_ORDER_IDSTR$)
	 group by ADVC_ORDER_ID
</select>
<!--预订单发货申请明细表更新 -->
<update id="updateSendChldById" parameterClass="map">
	<![CDATA[ update DRP_ADVC_SEND_REQ_DTL ]]>
	<dynamic prepend="set">
    <isNotNull property="DECT_RATE" prepend=","><![CDATA[DECT_RATE = #DECT_RATE# ]]></isNotNull>
    <isNotNull property="DECT_PRICE" prepend=","><![CDATA[DECT_PRICE = #DECT_PRICE# ]]></isNotNull>
    <isNotNull property="DECT_AMOUNT" prepend=","><![CDATA[DECT_AMOUNT = NOTICE_NUM*$DECT_PRICE$ ]]></isNotNull>
    </dynamic>
	<![CDATA[ where FROM_BILL_DTL_ID = #ADVC_ORDER_DTL_ID# and DEL_FLAG=0]]>
</update>
<!--销售出库明细表更新 -->
<update id="updateStoreChldById" parameterClass="map">
	<![CDATA[ update DRP_STOREOUT_DTL ]]>
	<dynamic prepend="set">
    <isNotNull property="DECT_RATE" prepend=","><![CDATA[DECT_RATE = #DECT_RATE# ]]></isNotNull>
    <isNotNull property="DECT_PRICE" prepend=","><![CDATA[DECT_PRICE = #DECT_PRICE# ]]></isNotNull>
    <isNotNull property="DECT_AMOUNT" prepend=","><![CDATA[DECT_AMOUNT = NOTICE_NUM*$DECT_PRICE$ ]]></isNotNull>
    </dynamic>
	<![CDATA[ where FROM_BILL_DTL_ID in (select ADVC_SEND_REQ_DTL_ID from  DRP_ADVC_SEND_REQ_DTL where FROM_BILL_DTL_ID= #ADVC_ORDER_DTL_ID# and DEL_FLAG=0) and DEL_FLAG=0]]>
</update>
<!-- 修改预订单发货申请主表金额 -->
<update id="updateSendMoney" parameterClass="map">
	update DRP_ADVC_SEND_REQ a set
		PAYABLE_AMOUNT=NVL((select sum(NVL(DECT_AMOUNT,0)) amount from DRP_ADVC_SEND_REQ_DTL b where b.ADVC_SEND_REQ_ID=a.ADVC_SEND_REQ_ID and DEL_FLAG=0 and PRD_TYPE='销售货品' ),0),
		STOREOUT_AMOUNT=NVL((select sum(NVL(DECT_AMOUNT,0)) amount from DRP_ADVC_SEND_REQ_DTL b where b.ADVC_SEND_REQ_ID=a.ADVC_SEND_REQ_ID and DEL_FLAG=0 ),0)
	where a.FROM_BILL_ID=#ADVC_ORDER_ID# and a.DEL_FLAG=0
</update>
<!-- 修改销售出库主表金额 -->
<update id="updateStoreMoney" parameterClass="map">
	update DRP_STOREOUT a set
		PAYABLE_AMOUNT=NVL((select sum(NVL(DECT_AMOUNT,0)) amount from DRP_STOREOUT_DTL b where b.STOREOUT_ID=a.STOREOUT_ID and DEL_FLAG=0 and PRD_TYPE='销售货品' ),0),
		STOREOUT_AMOUNT=NVL((select sum(NVL(DECT_AMOUNT,0)) amount from DRP_STOREOUT_DTL b where b.STOREOUT_ID=a.STOREOUT_ID and DEL_FLAG=0 ),0)
	where a.FROM_BILL_ID in (select c.ADVC_SEND_REQ_ID from DRP_ADVC_SEND_REQ c where c.FROM_BILL_ID=#ADVC_ORDER_ID# and c.DEL_FLAG=0) and a.DEL_FLAG=0
</update>
<insert id="insertAdvcNotes" parameterClass="map">
	insert into DRP_ADVC_NOTES_AMOUNT(
		BUSS_ID,
		DOCUMENTS_NO,
		CRE_TIME,
		CRE_NAME,
		ADVC_ORDER_ID,
		DEAL_STATE,
		CREATOR,
		DEAL_AMOUNT,
		REMARK
	)values(
		#BUSS_ID#,
		#DOCUMENTS_NO#,
		sysdate,
		#CRE_NAME#,
		#ADVC_ORDER_ID#,
		#DEAL_STATE#,
		#CREATOR#,
		#DEAL_AMOUNT#,
		#REMARK#
	)
</insert>
<select id="getAmount" parameterClass="string" resultClass="int">
	<![CDATA[
		select NVL(ADVC_AMOUNT,0) from DRP_ADVC_ORDER where ADVC_ORDER_ID=#ADVC_ORDER_ID#
	]]>
</select>
<select id="getDtlCount" parameterClass="string" resultClass="int">
	select count(1) CNT
          from DRP_ADVC_ORDER_DTL a
          left join DRP_SPCL_TECH b
            on a.SPCL_TECH_ID = b.SPCL_TECH_ID
           and USE_FLAG = 1
         where a.DEL_FLAG = 0
           and a.ADVC_ORDER_ID = #ADVC_ORDER_ID#
</select>
<update id="upPAYED_TOTAL_AMOUNTById" parameterClass="string">
	update DRP_ADVC_ORDER set PAYED_TOTAL_AMOUNT=NVL(ADVC_AMOUNT,0)
	where ADVC_ORDER_ID=#ADVC_ORDER_ID#
</update>
<select id="joinAdvcQuery" parameterClass="string" resultClass="java.util.HashMap">
<![CDATA[
select BUSS_NO,BUSS_TYPE,STATE,CRE_NAME,to_char(CRE_TIME,'yyyy-MM-DD HH24:MI:SS') CRE_TIME from (
	select d.ADVC_ORDER_NO BUSS_NO,
	       '预订单转订货订单' BUSS_TYPE,
	       d.STATE,
	       f.XM CRE_NAME,
	       e.TO_BASE_TIME CRE_TIME
	  from DRP_ADVC_ORDER d
	  left join DRP_ADVC_ORDER_DTL e
	    on d.ADVC_ORDER_ID = e.ADVC_ORDER_ID
	   and e.DEL_FLAG = 0
	  left join T_SYS_RYXX f
	    on f.RYXXID = e.TO_BASE_PSON_ID
	   and f.DELFLAG = 0
	 where e.IS_TO_BASE_FLAG = 1
	   and d.ADVC_ORDER_ID = #ADVC_ORDER_ID#
	   and rownum < 2
	union all
	select a.ADVC_SEND_REQ_NO BUSS_NO,
	       '发货申请单' BUSS_TYPE,
	       a.STATE,
	       a.CRE_NAME,
	       a.CRE_TIME
	  from DRP_ADVC_SEND_REQ a
	 where a.FROM_BILL_ID = #ADVC_ORDER_ID#
	   and a.DEL_FLAG = 0
	union all
	select b.STOREOUT_NO BUSS_NO,
	       '销售出库单' BUSS_TYPE,
	       b.STATE,
	       b.CRE_NAME,
	       b.CRE_TIME
	  from DRP_STOREOUT b
	  left join DRP_ADVC_SEND_REQ c
	    on b.FROM_BILL_ID = c.ADVC_SEND_REQ_ID
	   and c.DEL_FLAG = 0
	 where b.DEL_FLAG = 0
	   and c.FROM_BILL_ID = #ADVC_ORDER_ID#
	union all
	select g.STATEMENTS_NO BUSS_NO,
	       (case
	         when g.BILL_TYPE = '订金' then
	          g.BILL_TYPE || '收款单'
	         else
	          g.BILL_TYPE || '单'
	       end) BUSS_TYPE,
	       g.STATE,
	       g.CRE_NAME,
	       g.CRE_TIME
	  from DRP_STATEMENTS g
	 where g.ADVC_ORDER_ID = #ADVC_ORDER_ID#
	   and g.DEL_FLAG = 0
	   and g.STATEMENTS_NO is not null
	union all
	select h.ADVC_ORDER_NO BUSS_NO,
	       '退货单' BUSS_TYPE,
	       h.STATE,
	       h.CRE_NAME,
	       h.CRE_TIME
	  from DRP_ADVC_ORDER h
	 where h.FROM_BILL_ID =#ADVC_ORDER_ID#
	   and h.DEL_FLAG = 0
	union all
	select j.STATEMENTS_NO BUSS_NO,
	       '退货退款单' BUSS_TYPE,
	       j.STATE,
	       j.CRE_NAME,
	       j.CRE_TIME
	  from DRP_ADVC_ORDER i
	  left join DRP_STATEMENTS j
	    on i.ADVC_ORDER_ID = j.ADVC_ORDER_ID
	   and j.DEL_FLAG = 0
	 where i.DEL_FLAG = 0
	   and i.FROM_BILL_ID = #ADVC_ORDER_ID#
	   and j.STATEMENTS_NO is not null
	   ) order by CRE_TIME
]]>
</select>
<select id="getAdvcStatemNO" parameterClass="string" resultClass="string">
	$SQL$
</select>
<select id="checkCloseFlag" parameterClass="map" resultClass="int">
	select count(1) cnt from DRP_ADVC_ORDER_DTL a where a.DEL_FLAG=#DEL_FLAG# and a.ADVC_ORDER_ID=#ADVC_ORDER_ID# and a.STATE=#STATE#
</select>
<select id="getSendAdvcNum" parameterClass="map" resultClass="int">
	select count(1) cnt from DRP_ADVC_SEND_REQ a where a.FROM_BILL_ID=#ADVC_ORDER_ID# and a.DEL_FLAG=#DEL_FLAG#
</select>
<select id="getAdvcState" resultClass="string" parameterClass="string">
	select a.STATE from DRP_ADVC_ORDER a where a.ADVC_ORDER_ID=#ADVC_ORDER_ID# for update
</select>
<select id="getSumDtlNum" parameterClass="string" resultClass="int">
	select sum(NVL(SEND_NUM,0)-NVL(ORDER_NUM,0)) num from DRP_ADVC_ORDER_DTL where  ADVC_ORDER_DTL_ID in ($ADVC_ORDER_DTL_IDS$)
</select>
</sqlMap>