package com.hoperun.drp.finance.acctengi.action;/** * 项目名称：喜临门DM系统 * 系统名： * 文件名：AcctEngiAction.java */import java.io.PrintWriter;import java.util.HashMap;import java.util.List;import java.util.Map;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import org.apache.struts.action.ActionForm;import org.apache.struts.action.ActionForward;import org.apache.struts.action.ActionMapping;import com.hoperun.commons.action.BaseAction;import com.hoperun.commons.model.IListPage;import com.hoperun.commons.util.ParamUtil;import com.hoperun.commons.util.TimeComm;import com.hoperun.sys.model.UserBean;import com.hoperun.commons.util.StringUtil;import com.hoperun.drp.finance.acctengi.service.AcctEngiService;/** * @module * @func 二套帐月结 * @version 1.0 * @author zhuxw */public class AcctEngiAction extends BaseAction {	/** 业务逻辑对象 */	private AcctEngiService acctengiService;	public AcctEngiService getAcctengiService() {		return acctengiService;	}	public void setAcctengiService(AcctEngiService acctengiService) {		this.acctengiService = acctengiService;	}	public ActionForward toFrame(ActionMapping mapping, ActionForm form,			HttpServletRequest request, HttpServletResponse response) {		// 设置跳转时需要的一些公用属性		ParamUtil.setCommAttributeEx(request);		return mapping.findForward("frames");	}	/**	 * 查询结果列表	 * 	 * @param mapping	 *            ActionMapping	 * @param form	 *            ActionForm	 * @param request	 *            HttpServletRequest	 * @param response	 *            HttpServletResponse	 * @return ActionForward	 */	public ActionForward toList(ActionMapping mapping, ActionForm form,			HttpServletRequest request, HttpServletResponse response) {		Map<String, String> params = new HashMap<String, String>();		/**        ParamUtil.putStr2Map(request, "FINANCIAL_CYCLE", params);        ParamUtil.putStr2Map(request, "CYCLE_START", params);        ParamUtil.putStr2Map(request, "CYCLE_END", params);        ParamUtil.putStr2Map(request, "CYCLE_NAME", params);        ParamUtil.putStr2Map(request, "CYCLE_NAME", params);        **/		ParamUtil.putStr2Map(request, "YEAR", params);	    ParamUtil.putStr2Map(request, "MONTH", params);        UserBean userBean = (UserBean) request.getSession(false).getAttribute("UserBean");		params.put("LEDGER_NO", userBean.getCHANN_NO());		params.put("LEDGER_NAME", userBean.getCHANN_NAME());		params.put("IS_DRP_LEDGER", userBean.getIS_DRP_LEDGER());		params.put("LEDGER_ID", userBean.getCHANN_ID());		if("1".equals(userBean.getIS_DRP_LEDGER()))		{			params.put("LEDGER_IDS", "('"+userBean.getCHANN_ID()+"')");		}else		{			params.put("LEDGER_IDS", userBean.getCHANNS_CHARG());		}		params.put("CUR_YEAR",TimeComm.getYear());		params.put("CUR_MONTH",TimeComm.getMonth());		ParamUtil.setOrderField(request, params);		params.put("orderField","  u.YEAR DESC , u.MONTH DESC ");		int pageNo = ParamUtil.getInt(request, "pageNo", 1);				try {			IListPage page = acctengiService.pageQuery(params, pageNo);			request.setAttribute("page", page);		} catch (RuntimeException e) {			e.printStackTrace();		}		request.setAttribute("params", params);				return mapping.findForward("list");	}	/**	 * 判断是否满足二套帐月结条件	 * 	 * @param mapping	 *            ActionMapping	 * @param form	 *            ActionForm	 * @param request	 *            HttpServletRequest	 * @param response	 *            HttpServletResponse	 * @return ActionForward	 */	@SuppressWarnings("unchecked")	public void chkAccount(ActionMapping mapping, ActionForm form,			HttpServletRequest request, HttpServletResponse response) {		PrintWriter writer = getWriter(response);		String jsonResult = jsonResult();		try {			UserBean userBean = (UserBean) request.getSession(false).getAttribute("UserBean");			String vYEAR = request.getParameter("YEAR");			String vMONTH = request.getParameter("MONTH");			Map params=new HashMap();			params.put("LEDGER_ID", userBean.getLoginZTXXID());			params.put("LEDGER_NAME", userBean.getLoginZTMC());			params.put("CREATOR", userBean.getXTYHID());			params.put("CRE_NAME", userBean.getXM());			params.put("DEPT_ID",userBean.getBMXXID());			params.put("DEPT_NAME",userBean.getBMMC());			params.put("ORG_ID",userBean.getJGXXID());			params.put("ORG_NAME",userBean.getJGMC());			params.put("YEAR", vYEAR);			params.put("MONTH", vMONTH);			params.put("YEAR_MONTH", vYEAR+vMONTH);		    String preYearMonth[]=preYearMonth(vYEAR,vMONTH);			    params.put("PRE_YEAR", preYearMonth[0]);			params.put("PRE_MONTH", preYearMonth[1]);			params.put("STATE", "已生成");			Map channMap=acctengiService.getChannInfo(params);			if(channMap!=null)			{				String init_year=StringUtil.nullToSring(channMap.get("INIT_YEAR"));				String init_month=StringUtil.nullToSring(channMap.get("INIT_MONTH"));				if(StringUtil.isEmpty(init_year)||StringUtil.isEmpty(init_month))				{					jsonResult = jsonResult(false, "渠道没有维护初始化年份、月份信息,请在渠道参数设置页面!");				}else				{					Map chkMap=acctengiService.chkAccount(params);                    if(Integer.parseInt(init_year+init_month)>=Integer.parseInt(vYEAR+vMONTH))					{						jsonResult = jsonResult(false, "您选择的年份、月份必须在:"+init_year+init_month+"之后！");					}					else if(init_year.equals(preYearMonth[0])&&init_month.equals(preYearMonth[1]))					{					    if("1".equals(chkMap.get("THE_NUM").toString()))						{							jsonResult = jsonResult(false, "当前月份已经生成!");						}else						{							jsonResult = jsonResult(true, "");													}												}									}								}else			{				jsonResult = jsonResult(false, "找不到对应的渠道信息!");							}			} catch (Exception e) {			jsonResult = jsonResult(false, "生成失败:"+e.getMessage());		}		if (null != writer) {			writer.write(jsonResult);			writer.close();		}	}		/**	 * 开始生成	 * 	 * @param mapping	 *            ActionMapping	 * @param form	 *            ActionForm	 * @param request	 *            HttpServletRequest	 * @param response	 *            HttpServletResponse	 * @return ActionForward	 */	@SuppressWarnings("unchecked")	public void doAccount(ActionMapping mapping, ActionForm form,			HttpServletRequest request, HttpServletResponse response) {		PrintWriter writer = getWriter(response);		String jsonResult = jsonResult();		try {			UserBean userBean = (UserBean) request.getSession(false).getAttribute("UserBean");			String vYEAR = request.getParameter("YEAR");			String vMONTH = request.getParameter("MONTH");						Map params=new HashMap();			params.put("LEDGER_ID", userBean.getLoginZTXXID());			params.put("LEDGER_NAME", userBean.getLoginZTMC());			params.put("CREATOR", userBean.getXTYHID());			params.put("CRE_NAME", userBean.getXM());			params.put("DEPT_ID",userBean.getBMXXID());			params.put("DEPT_NAME",userBean.getBMMC());			params.put("ORG_ID",userBean.getJGXXID());			params.put("ORG_NAME",userBean.getJGMC());			params.put("YEAR", vYEAR);			params.put("MONTH", vMONTH);			params.put("YEAR_MONTH", vYEAR+vMONTH);		    String preYearMonth[]=preYearMonth(vYEAR,vMONTH);			    params.put("PRE_YEAR", preYearMonth[0]);			params.put("PRE_MONTH", preYearMonth[1]);			params.put("UPD_NAME", userBean.getXM());			Map chkMap=acctengiService.chkNotice(params);			params.put("IS_NOTICE_FLAG",chkMap.get("IS_NOTICE_FLAG"));						Map channMap=acctengiService.getChannInfo(params);			if(channMap!=null)			{				params.put("COST_TYPE",channMap.get("COST_TYPE"));			}			acctengiService.txDoAccount(params);			jsonResult = jsonResult(true, "生成成功！");					} catch (Exception e) {			jsonResult = jsonResult(false, "生成失败:"+e.getMessage());			e.printStackTrace();		}		if (null != writer) {			writer.write(jsonResult);			writer.close();		}	}		/**	 * 取消生成	 * 	 * @param mapping	 *            ActionMapping	 * @param form	 *            ActionForm	 * @param request	 *            HttpServletRequest	 * @param response	 *            HttpServletResponse	 * @return ActionForward	 */	@SuppressWarnings("unchecked")	public void cancleAccount(ActionMapping mapping, ActionForm form,			HttpServletRequest request, HttpServletResponse response) {		PrintWriter writer = getWriter(response);		String jsonResult = jsonResult();		try {			UserBean userBean = (UserBean) request.getSession(false).getAttribute("UserBean");			String vCHANN_ID = request.getParameter("CHANN_ID");			String vYEAR = request.getParameter("YEAR");			String vMONTH = request.getParameter("MONTH");			Map params=new HashMap();			//params.put("LEDGER_ID", vCHANN_ID);			params.put("YEAR", vYEAR);			params.put("MONTH", vMONTH);			params.put("LEDGER_ID", userBean.getLoginZTXXID());			params.put("YEAR_MONTH", vYEAR+vMONTH);			params.put("YEAR", vYEAR);			params.put("MONTH", vMONTH);		    String nexYearMonth[]=nexYearMonth(vYEAR,vMONTH);			    params.put("NEX_YEAR", nexYearMonth[0]);			params.put("NEX_MONTH", nexYearMonth[1]);			params.put("UPD_NAME", userBean.getXM());			Map chkMap=acctengiService.chkPreAccount(params);			if("1".equals(chkMap.get("IS_ACCT_FLAG").toString()))			{				jsonResult = jsonResult(false, "请先取消下一个月份的生成!");			}else			{				acctengiService.txCancleAccount(params);				jsonResult = jsonResult(true, "取消生成成功！");							}					} catch (Exception e) {			jsonResult = jsonResult(false, "取消生成失败:"+e.getMessage());			e.printStackTrace();		}		if (null != writer) {			writer.write(jsonResult);			writer.close();		}	}		/**	 * 获得前一个月份	 * 	 * @return ActionForward	 */	public String[] nexYearMonth (String year,String month) {		String [] year_Month=new String [2];		if(month.equals("12"))		{			year_Month[0]=String.valueOf(Integer.parseInt(year)+1);			year_Month[1]="01";		}else if(month.equals("11"))		{			year_Month[0]=year;			year_Month[1]="12";					}else if(month.equals("10"))		{			year_Month[0]=year;			year_Month[1]="11";					}else if(month.equals("09"))		{			year_Month[0]=year;			year_Month[1]="10";					}else if(month.equals("08"))		{			year_Month[0]=year;			year_Month[1]="09";					}else if(month.equals("07"))		{			year_Month[0]=year;			year_Month[1]="08";					}else if(month.equals("06"))		{			year_Month[0]=year;			year_Month[1]="07";					}else if(month.equals("05"))		{			year_Month[0]=year;			year_Month[1]="06";					}else if(month.equals("04"))		{			year_Month[0]=year;			year_Month[1]="05";					}else if(month.equals("03"))		{			year_Month[0]=year;			year_Month[1]="04";					}else if(month.equals("02"))		{			year_Month[0]=year;			year_Month[1]="03";					}else if(month.equals("01"))		{			year_Month[0]=year;			year_Month[1]="02";					}		return year_Month;	}		/**	 * 获得后一个月份	 * 	 * @return ActionForward	 */	public String[] preYearMonth (String year,String month) {		String [] year_Month=new String [2];		if(month.equals("12"))		{			year_Month[0]=year;			year_Month[1]="11";		}else if(month.equals("11"))		{			year_Month[0]=year;			year_Month[1]="10";					}else if(month.equals("10"))		{			year_Month[0]=year;			year_Month[1]="09";					}else if(month.equals("09"))		{			year_Month[0]=year;			year_Month[1]="08";					}else if(month.equals("08"))		{			year_Month[0]=year;			year_Month[1]="07";					}else if(month.equals("08"))		{			year_Month[0]=year;			year_Month[1]="07";					}else if(month.equals("07"))		{			year_Month[0]=year;			year_Month[1]="06";					}else if(month.equals("06"))		{			year_Month[0]=year;			year_Month[1]="05";					}else if(month.equals("05"))		{			year_Month[0]=year;			year_Month[1]="04";					}else if(month.equals("04"))		{			year_Month[0]=year;			year_Month[1]="03";					}else if(month.equals("03"))		{			year_Month[0]=year;			year_Month[1]="02";					}else if(month.equals("02"))		{			year_Month[0]=year;			year_Month[1]="01";					}else if(month.equals("01"))		{			year_Month[0]=String.valueOf(Integer.parseInt(year)-1);			year_Month[1]="12";					}		return year_Month;	}							}